<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日历</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <style>
        /* 基础设置 */
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { scrollbar-width: none; }

        .watermark-font {
            font-family: 'Oswald', sans-serif;
            user-select: none;
        }

        /* 背景水印容器 */
        #fixed-watermark-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
            pointer-events: none;
            text-align: center;
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .watermark-change {
            animation: watermarkPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes watermarkPop {
            0% { transform: translate(-50%, -50%) scale(0.95); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .sticky-header {
            background: rgba(248, 250, 252, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .first-day-label {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: #94a3b8;
            font-weight: 700;
            white-space: nowrap;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.4s;
        }

        .today-glow {
            box-shadow: 0 4px 20px rgba(30, 41, 59, 0.25);
        }

        /* 选中/跳转日期的强调效果 */
        .highlight-ring {
            animation: ringPulse 2s ease-out forwards;
        }

        @keyframes ringPulse {
            0% { box-shadow: 0 0 0 0 rgba(30, 41, 59, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(30, 41, 59, 0); }
            100% { box-shadow: 0 0 0 0 rgba(30, 41, 59, 0); }
        }

        /* --- 核心交互样式 --- */

        /* 默认日期单元格：非活跃状态（沉下去） */
        .day-cell {
            opacity: 0.35;
            transform: scale(0.95);
            filter: blur(0);
            transition: all 0.5s ease-out;
        }

        /* 活跃月份的日期：悬浮状态（浮上来） */
        .day-cell.active-month {
            opacity: 1;
            transform: scale(1);
            filter: blur(0);
        }

        /* 活跃月份中的1号标签也跟着高亮 */
        .day-cell.active-month .first-day-label {
            color: #475569;
            background: #e2e8f0;
        }

        /* 周末在活跃状态下的颜色 */
        .day-cell.active-month .is-weekend {
            color: #94a3b8;
        }

        /* 隐藏的日期输入框 - 跨平台兼容 */
        #date-picker-input {
            position: absolute;
            opacity: 0;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            border: none;
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col overflow-hidden text-slate-800">

    <!-- 1. 背景层：固定水印 -->
    <div id="fixed-watermark-container" class="watermark-font text-slate-200">
        <!-- 年份加深：opacity-60 -->
        <div id="wm-year" class="text-[5rem] leading-none tracking-widest opacity-60 mix-blend-multiply mb-2"></div>
        <!-- 月份加深：颜色改回 slate-300，opacity 提升到 40% -->
        <div id="wm-month" class="text-[12rem] leading-none font-bold text-slate-300 opacity-40 mix-blend-multiply"></div>
    </div>

    <!-- 2. 前景层：顶部星期栏 -->
    <header class="sticky-header z-50 w-full flex justify-between px-2 py-4 flex-shrink-0 shadow-sm">
        <div class="grid grid-cols-7 w-full max-w-2xl mx-auto text-center font-bold text-slate-400 text-xs tracking-wider">
            <span>SUN</span>
            <span>MON</span>
            <span>TUE</span>
            <span>WED</span>
            <span>THU</span>
            <span>FRI</span>
            <span>SAT</span>
        </div>
    </header>

    <!-- 3. 滚动容器 -->
    <main id="scroll-container" class="flex-1 overflow-y-auto no-scrollbar relative z-10">
        <div id="calendar-grid" class="grid grid-cols-7 gap-y-6 gap-x-1 max-w-2xl mx-auto pt-8 pb-32 px-2">
            <!-- 日期单元格 -->
        </div>
        <div id="loading-trigger" class="h-20 w-full flex justify-center items-center opacity-0"></div>
    </main>
    
    <!-- 悬浮操作区 -->
    <div class="fixed bottom-10 right-8 z-50 flex flex-col gap-4">
        
        <!-- 隐藏的 input -->
        <input type="date" id="date-picker-input">

        <!-- 选择日期按钮 -->
        <button onclick="openDatePicker()" class="bg-white text-slate-700 w-14 h-14 rounded-full shadow-xl flex items-center justify-center hover:bg-slate-50 transition-all active:scale-95 hover:-translate-y-1 border border-slate-100" title="跳转到日期">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        </button>

        <!-- 返回今天按钮 -->
        <button onclick="scrollToToday()" class="bg-slate-800 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center hover:bg-slate-700 transition-all active:scale-95 hover:-translate-y-1" title="回到今天">
            <span class="text-xs font-bold">今天</span>
        </button>
    </div>

    <script>
        const grid = document.getElementById('calendar-grid');
        const trigger = document.getElementById('loading-trigger');
        const wmYear = document.getElementById('wm-year');
        const wmMonth = document.getElementById('wm-month');
        const wmContainer = document.getElementById('fixed-watermark-container');
        const datePicker = document.getElementById('date-picker-input');

        let currentRenderDate = new Date();
        const today = new Date();
        let currentWatermark = { year: 0, month: 0 };

        // 初始化日期：设置为两个月前
        function resetToDate(targetDate) {
            // 清空网格
            grid.innerHTML = '';
            
            // 计算渲染起始点：目标日期的前一个月，以保持上下文
            currentRenderDate = new Date(targetDate);
            currentRenderDate.setDate(1); 
            currentRenderDate.setMonth(currentRenderDate.getMonth() - 1); 
            
            // 对齐到周日
            const startDay = currentRenderDate.getDay();
            currentRenderDate.setDate(currentRenderDate.getDate() - startDay);
            
            // 重置水印状态，强制更新
            currentWatermark = { year: 0, month: 0 };
        }

        // 核心：高亮当前月份日期的函数
        function highlightCurrentMonthDays(year, month) {
            const cells = document.querySelectorAll('.day-cell');
            requestAnimationFrame(() => {
                cells.forEach(cell => {
                    const cYear = parseInt(cell.dataset.year);
                    const cMonth = parseInt(cell.dataset.month);

                    if (cYear === year && cMonth === month) {
                        cell.classList.add('active-month');
                    } else {
                        cell.classList.remove('active-month');
                    }
                });
            });
        }

        const loadObserver = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                renderNextBatch(90); 
            }
        }, { root: document.getElementById('scroll-container'), threshold: 0.1 });

        const watermarkObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const year = parseInt(entry.target.dataset.year);
                    const month = parseInt(entry.target.dataset.month);
                    updateWatermark(year, month);
                }
            });
        }, { 
            root: document.getElementById('scroll-container'), 
            rootMargin: '-45% 0px -45% 0px',
            threshold: 0
        });

        function updateWatermark(year, month) {
            if (currentWatermark.year === year && currentWatermark.month === month) return;
            
            currentWatermark = { year, month };
            
            wmContainer.classList.remove('watermark-change');
            void wmContainer.offsetWidth; 
            wmContainer.classList.add('watermark-change');

            wmYear.textContent = year;
            wmMonth.textContent = (month + 1).toString().padStart(2, '0');

            highlightCurrentMonthDays(year, month);
        }

        function createDayElement(date) {
            const d = date.getDate();
            const m = date.getMonth();
            const y = date.getFullYear();
            const dayOfWeek = date.getDay();
            
            const isToday = d === today.getDate() && m === today.getMonth() && y === today.getFullYear();
            const isFirstDay = d === 1;

            const cell = document.createElement('div');
            cell.className = 'day-cell flex flex-col items-center justify-start h-14 relative';
            
            // 预激活
            if (y === currentWatermark.year && m === currentWatermark.month) {
                cell.classList.add('active-month');
            }

            cell.dataset.date = d;
            cell.dataset.month = m;
            cell.dataset.year = y;

            if (d === 15) {
                watermarkObserver.observe(cell);
            }
            if (grid.children.length === 0) {
                updateWatermark(y, m);
            }

            const circle = document.createElement('div');
            let circleClass = 'w-10 h-10 flex items-center justify-center rounded-full text-lg font-medium transition-all duration-300 ';
            
            if (isToday) {
                circleClass += 'bg-slate-800 text-white today-glow scale-110 z-10 shadow-lg';
                cell.id = 'today-marker'; 
            } else if (dayOfWeek === 0 || dayOfWeek === 6) {
                circleClass += 'is-weekend text-slate-400'; 
            } else {
                circleClass += 'text-slate-700';
            }
            
            if (isFirstDay && !isToday) {
                circleClass += ' font-bold text-slate-800 bg-white ring-1 ring-slate-200 shadow-sm';
            }

            circle.className = circleClass;
            circle.textContent = d;

            if (isFirstDay) {
                const label = document.createElement('span');
                label.className = 'first-day-label';
                label.textContent = `${m + 1}月`;
                cell.appendChild(label);
                watermarkObserver.observe(cell);
            }

            cell.appendChild(circle);
            return cell;
        }

        function renderNextBatch(daysCount) {
            const frag = document.createDocumentFragment();
            for (let i = 0; i < daysCount; i++) {
                const el = createDayElement(new Date(currentRenderDate));
                frag.appendChild(el);
                currentRenderDate.setDate(currentRenderDate.getDate() + 1);
            }
            grid.appendChild(frag);
        }

        // --- 跳转与日期处理逻辑 ---

        function openDatePicker() {
            // 通用兼容方案：同时触发多种方式
            const input = datePicker;
            
            // 方法1: 尝试 showPicker (现代浏览器)
            if (input.showPicker) {
                try {
                    input.showPicker();
                } catch (e) {
                    // 如果失败，继续执行其他方法
                }
            }
            
            // 方法2: 传统方式 (iOS 等)
            input.focus();
            
            // 方法3: 触发点击
            setTimeout(() => {
                input.click();
            }, 10);
        }

        datePicker.addEventListener('change', (e) => {
            if (!e.target.value) return;
            // 解析 YYYY-MM-DD 为本地时间
            const parts = e.target.value.split('-');
            const targetDate = new Date(parts[0], parts[1] - 1, parts[2]);
            jumpToDate(targetDate);
        });

        function jumpToDate(targetDate) {
            // 1. 重置网格
            resetToDate(targetDate);
            
            // 2. 渲染足够覆盖目标日期的天数 (例如前后半年)
            renderNextBatch(180);

            // 3. 查找并滚动
            setTimeout(() => {
                const selector = `.day-cell[data-year="${targetDate.getFullYear()}"][data-month="${targetDate.getMonth()}"][data-date="${targetDate.getDate()}"]`;
                const el = document.querySelector(selector);
                
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // 添加视觉提示
                    const circle = el.querySelector('div');
                    circle.classList.add('highlight-ring');
                    setTimeout(() => circle.classList.remove('highlight-ring'), 2000);
                    
                    // 立即更新水印
                    updateWatermark(targetDate.getFullYear(), targetDate.getMonth());
                }
            }, 50); // 给一点点渲染时间
        }

        function scrollToToday() {
            const todayEl = document.getElementById('today-marker');
            if (todayEl) {
                // 如果今天已经在 DOM 中，直接滚动
                todayEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const y = parseInt(todayEl.dataset.year);
                const m = parseInt(todayEl.dataset.month);
                updateWatermark(y, m);
                
                // 视觉反馈
                const circle = todayEl.querySelector('div');
                circle.classList.add('highlight-ring');
                setTimeout(() => circle.classList.remove('highlight-ring'), 2000);
            } else {
                // 如果今天被清理掉了（例如跳转到了很远的日期），则重新初始化
                jumpToDate(new Date());
            }
        }

        // 初始化
        function init() {
            resetToDate(new Date()); // 初始化时以今天为基准
            renderNextBatch(365); 
            loadObserver.observe(trigger);
            setTimeout(() => {
                scrollToToday();
            }, 100);
        }

        init();
    </script>
</body>
</html>