<!-- Chosen Palette: Warm Neutral & Calm Harmony (Background: #F9FAFB, Cards: #FFFFFF, Accents: #6366F1, #10B981, #F59E0B) -->
<!-- Application Structure Plan:
    1.  **Header & Configuration:** Top bar containing the core inputs (Birth Date, Life Expectancy) that drive the entire data generation. This allows immediate personalization.
    2.  **Dashboard Overview (The "Analysis" Layer):** Before diving into the details, a dashboard section uses Chart.js to visualize "Life Progress" (Time Spent vs. Remaining) and "Event Categorization" (Distribution of tagged memories). This synthesizes the quantitative aspect of a life span.
    3.  **The Life Grid (The "Exploration" Layer):** The core interface. A responsive grid where each item represents a 'Year'.
        * **Year Card:** Displays Age, Gregorian Year, Zodiac AND Constellation.
        * **Season Blocks:** Inside each year, 4 clickable quadrants. ORDER is dynamic based on birth season (e.g., if born in Summer, row starts with Summer).
        * **Contextual Layers:** Editable "World Events" layer.
    4.  **Interaction Flow:** User sets DOB -> Grid Generates -> User clicks a Season -> Modal appears (Edit Title, Content, Color, AND World Context) -> Save.
    5.  **Storage:** Uses browser `localStorage` to persist data (Events, Settings, and World Context).
-->
<!-- Visualization & Content Choices:
    1.  **Life Progress (Doughnut Chart):** Goal: Inform. Shows the finite nature of the configured lifespan.
    2.  **Memory Distribution (Bar Chart):** Goal: Organize/Compare. Visualizes category distribution.
    3.  **The Grid (Dynamic HTML/Tailwind):** Goal: Organize & Change. 
        - **UPDATED:** Rows start from birth season.
        - **UPDATED:** Cells show Titles.
    4.  **World Context (Text Injection):** Goal: Inform & Edit. Now editable via the modal.
-->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

<!DOCTYPE html>
<html lang="zh-CN">
<link rel="icon" type="image/svg+xml"
href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2232%22%20height%3D%2232%22%20viewBox%3D%220%200%2032%2032%22%20fill%3D%22none%22%3E%3C!--%20%E5%B7%A6%E4%BE%A7%E9%A1%B5%E9%9D%A2%EF%BC%9A%E4%BD%BF%E7%94%A8%E7%B1%BB%E4%BC%BC%20bg-orange-200%20%E7%9A%84%E8%89%B2%E5%80%BC%20(%23FEEBC8)%20%E5%A1%AB%E5%85%85%20--%3E%3Cpath%20d%3D%22M4%2024C4%2024.7909%205.79086%2020%208%2020H16V28H8C5.79086%2028%204%2026.2091%204%2024Z%22%20fill%3D%22%23FEEBC8%22%20fill-opacity%3D%221%22%2F%3E%3C!--%20%E5%8F%B3%E4%BE%A7%E9%A1%B5%E9%9D%A2%EF%BC%9A%E5%8D%8A%E9%80%8F%E6%98%8E%E7%99%BD%E8%89%B2%E5%A1%AB%E5%85%85%20--%3E%3Cpath%20d%3D%22M16%2020H24C26.2091%2020%2028%2024.7909%2028%2024C28%2026.2091%2026.2091%2028%2024%2028H16V20Z%22%20fill%3D%22white%22%20fill-opacity%3D%220.9%22%2F%3E%3C!--%20%E4%B8%BB%E4%B9%A6%E9%A1%B5%E7%BA%BF%E6%9D%A1%EF%BC%9A%E5%AE%9E%E7%BA%BF%20--%3E%3Cpath%20d%3D%22M16%2020C16%2014%2020%208%2022%206%22%20stroke%3D%22white%22%20stroke-width%3D%220.9%22%20stroke-linecap%3D%22round%22%20fill%3D%22%23FFFFFF%22%20fill-opacity%3D%221%22%2F%3E%3C%2Fsvg%3E">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶å…‰æŠ˜é¡µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Noto+Sans+SC:wght@300;400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #eedccd;
            --primary-glow: rgba(71, 85, 105, 0.2);
            --bg-color: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.8);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --season-border: rgba(0, 0, 0, 0.04);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.03), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --hover-shadow: 0 20px 25px -5px rgba(71, 85, 105, 0.1), 0 10px 10px -5px rgba(71, 85, 105, 0.04);
        }

        body {
            font-family: 'Outfit', 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            background-image:
                radial-gradient(at 0% 0%, rgba(71, 85, 105, 0.03) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(51, 65, 85, 0.03) 0px, transparent 50%);
            color: #4f1519b7;
            scroll-behavior: smooth;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--card-shadow);
        }

        .navbar-glass {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 300px;
            margin: 0 auto;
        }

        .season-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            min-height: 140px;
        }

        .season-cell {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            overflow-y: auto;
            text-align: left;
            padding: 8px;
            min-height: 90px;
            border-radius: 12px;
            border: 1px solid var(--season-border);
            background: white;
        }

        .season-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.06);
            z-index: 2;
        }

        .event-title-tag {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            padding: 2px 6px;
            margin-bottom: 4px;
            font-weight: 600;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: 0.7rem;
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .year-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
        }

        .year-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--hover-shadow);
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--primary), #1e293b49);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #modalContent {
            border-radius: 28px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 0 15px var(--primary-glow);
            border: 2px solid white;
        }
    </style>
</head>

<body class="flex flex-col min-h-screen">

    <!-- Navbar / Header -->
    <header class="navbar-glass sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-12 h-12 bg-orange-200 rounded-2xl flex items-center justify-center shadow-lg shadow-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <!-- å·¦ä¾§é¡µé¢ï¼šä½¿ç”¨ç±»ä¼¼ bg-orange-200 çš„è‰²å€¼ (#FEEBC8) å¡«å…… -->
                    <path d="M4 24C4 24.7909 5.79086 20 8 20H16V28H8C5.79086 28 4 26.2091 4 24Z" fill="#FEEBC8" fill-opacity="1"/>

                    <!-- å³ä¾§é¡µé¢ï¼šåŠé€æ˜ç™½è‰²å¡«å…… -->

                    <path d="M16 20H24C26.2091 20 28 24.7909 28 24C28 26.2091 26.2091 28 24 28H16V20Z" fill="white" fill-opacity="0.9"/>

                    <!-- ä¸»ä¹¦é¡µçº¿æ¡ï¼šå®çº¿ -->

                    <path d="M16 20C16 14 20 8 22 6" stroke="white" stroke-width="0.9" stroke-linecap="round" fill="#FFFFFF" fill-opacity="1"/>

                    </svg>
                </div>
                <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight text-orange-300 leading-tight">
                    æ—¶å…‰<br><span class="gradient-text">æŠ˜é¡µ</span>
                </h1>
            </div>
            <div class="flex items-center gap-2 sm:gap-4 text-sm">
                <button onclick="exportData()" title="å¯¼å‡ºæ•°æ®"
                    class="bg-slate-100 text-slate-700 w-9 h-9 sm:w-10 sm:h-10 rounded-xl font-semibold hover:bg-slate-200 transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                </button>
                <button onclick="document.getElementById('importFile').click()" title="å¯¼å…¥æ•°æ®"
                    class="bg-slate-100 text-slate-700 w-9 h-9 sm:w-10 sm:h-10 rounded-xl font-semibold hover:bg-slate-200 transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                </button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
                <button id="resetDataBtn" title="é‡ç½®æ•°æ®"
                    class="text-slate-400 hover:text-red-500 transition-colors w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
                <div class="bg-orange-200 text-white px-3 py-2 sm:px-4 rounded-2xl font-bold shadow-lg shadow-slate-200 text-xs sm:text-sm whitespace-nowrap"
                    id="currentAgeDisplay">
                    è®¡ç®—ä¸­...
                </div>
            </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <!-- 1. Introduction & Configuration Section -->
        <section class="glass-card rounded-[2rem] p-8">
            <div class="mb-8">
                <h2 class="text-2xl font-extrabold text-slate-900 mb-2">å®šåˆ¶ä½ çš„æ—¶å…‰æŠ˜é¡µ</h2>
                <p class="text-slate-500 text-sm leading-relaxed max-w-2xl">
                    å®šä¹‰äººç”Ÿçš„èµ·è·‘çº¿å’Œé¢„æœŸç»ˆç‚¹ã€‚ç³»ç»Ÿå°†æ ¹æ®ä½ çš„å‡ºç”Ÿæ—¥æœŸè‡ªåŠ¨ç”Ÿæˆæ—¶é—´ç½‘æ ¼ã€‚
                    å½©è‰²æ–¹å—ä»£è¡¨å·²æµé€çš„æ—¶é—´ï¼Œç©ºç™½ç”»å¸ƒä»£è¡¨æ— é™å¯èƒ½çš„æœªæ¥ã€‚
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 flex justify-between items-center">
                        <span>å‡ºç”Ÿæ—¥æœŸ</span>
                        <span id="constellationDisplay" class="text-xs text-slate-500 font-semibold"></span>
                    </label>
                    <input type="date" id="birthDateInput"
                        class="w-full border-gray-300 rounded-md shadow-sm focus:border-slate-500 focus:ring-slate-500 p-2 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é¢„æœŸå¯¿å‘½ (å¹´)</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="lifeExpectancyInput" min="60" max="120" value="80"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="lifeExpectancyValue"
                            class="text-sm font-mono text-gray-900 w-12 text-center">80</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¯è¡Œæ˜¾ç¤ºå¹´ä»½</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="yearsPerRowInput" min="1" max="5" value="1"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="yearsPerRowValue" class="text-sm font-mono text-gray-900 w-12 text-center">1</span>
                    </div>
                </div>
                <div class="flex items-center gap-4 pt-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="showZodiacToggle" class="sr-only peer" checked>
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-slate-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-slate-600 relative">
                        </div>
                        <span class="ml-3 text-sm font-medium text-gray-700">æ˜¾ç¤ºç”Ÿè‚–</span>
                    </label>
                </div>
            </div>
        </section>

        <!-- 2. Dashboard / Analytics Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Life Progress Chart -->
            <div class="glass-card rounded-[2rem] p-8 flex flex-col">
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-slate-900">äººç”Ÿè¿›åº¦æ¦‚è§ˆ</h3>
                    <p class="text-xs text-slate-400 mt-1 uppercase tracking-wider font-semibold">
                        åŸºäºå½“å‰é…ç½®çš„æ—¶é—´æµé€æ¯”ä¾‹
                    </p>
                </div>
                <div class="flex-grow flex items-center justify-center">
                    <div class="chart-container">
                        <canvas id="lifeProgressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Event Categories Chart -->
            <div class="glass-card rounded-[2rem] p-8 flex flex-col">
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-slate-900">è®°å¿†åˆ†ç±»ç»Ÿè®¡</h3>
                    <p class="text-xs text-slate-400 mt-1 uppercase tracking-wider font-semibold">
                        åœ¨äººç”Ÿç½‘æ ¼ä¸­è®°å½•çš„å„ç±»äº‹ä»¶åˆ†å¸ƒ
                    </p>
                </div>
                <div class="flex-grow flex items-center justify-center">
                    <div class="chart-container">
                        <canvas id="eventDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. The Life Grid Section -->
        <section>
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
                <div>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tight mb-2">ä½ çš„æ—¶é—´è½´</h2>
                    <p class="text-sm text-slate-500 max-w-xl">
                        æ¯ä¸€ä¸ªå¡ç‰‡ä»£è¡¨ä¸€å²ï¼Œæ¯ä¸€å°æ ¼ä»£è¡¨ä¸€ä¸ªå­£åº¦ï¼ˆç”±å‡ºç”Ÿå­£èŠ‚å¼€å§‹æ’åˆ—ï¼‰ã€‚
                    </p>
                </div>
                <div class="flex gap-4">
                    <div class="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-widest">
                        <span class="w-4 h-4 bg-orange-400/15 rounded-lg border border-orange-500/20"></span> è¿‡å»
                        <span class="w-4 h-4 bg-emerald-500/10 rounded-lg border border-emerald-500/20 ml-2"></span> ç°åœ¨
                        <span class="w-4 h-4 bg-white rounded-lg border border-slate-200 ml-2"></span> æœªæ¥
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="flex flex-wrap gap-2 mb-6" id="tagFilters">
                <!-- Populated by JS -->
            </div>

            <!-- Grid Container -->
            <div id="lifeGrid"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                <!-- Grid Items Generated via JS -->
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-8 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm">Â© 2025 æ—¶å…‰æŠ˜é¡µ (Time Folding). åŸºäºDorawlfåˆ›æ„æ„å»ºã€‚</p>
        </div>
    </footer>

    <!-- Edit Modal -->
    <div id="editModal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden z-[100] flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 overflow-hidden transform transition-all scale-95 flex flex-col max-h-[90vh]"
            id="modalContent">
            <div
                class="px-8 py-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center flex-shrink-0">
                <h3 class="text-xl font-bold text-slate-900" id="modalTitle">ç¼–è¾‘è®°å½•</h3>
                <button onclick="closeModal()"
                    class="w-10 h-10 rounded-full bg-slate-200 hover:bg-slate-300 text-slate-600 transition-colors flex items-center justify-center font-bold text-xl">Ã—</button>
            </div>

            <div class="p-8 space-y-6 overflow-y-auto flex-grow" id="modalBody">

                <!-- World Context Edit -->
                <div class="bg-slate-50 p-5 rounded-3xl border border-slate-200 mb-2">
                    <label class="block text-[10px] font-black text-slate-600 uppercase tracking-widest mb-2">ğŸŒ å½“å¹´å†å²èƒŒæ™¯
                        (å¯ç¼–è¾‘):</label>
                    <input type="text" id="modalWorldContextInput"
                        class="w-full text-xs text-slate-700 bg-white border-slate-200 rounded-2xl px-4 py-2.5 focus:ring-2 focus:ring-slate-400 outline-none border transition-all"
                        placeholder="ä¾‹å¦‚ï¼šå¥¥è¿ä¼šä¸¾åŠ...">
                </div>

                <hr class="border-slate-100/50">

                <!-- Event List Area -->
                <div id="eventListArea" class="space-y-4">
                    <!-- Existing events will be listed here with Edit/Delete -->
                </div>

                <div id="addNewEventArea" class="bg-slate-50/50 rounded-[2rem] p-8 border border-slate-100">
                    <h4 class="text-sm font-black text-slate-700 uppercase tracking-widest mb-6" id="formHeader">æ·»åŠ æ–°è®°å½•
                    </h4>
                    <div class="space-y-5">
                        <!-- Event Title -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1.5 ml-1">æ ‡é¢˜</label>
                            <input type="text" id="eventTitle"
                                class="w-full border-slate-200 rounded-2xl focus:border-slate-500 focus:ring-4 focus:ring-slate-100 p-4 border outline-none transition-all placeholder:text-slate-300 text-sm"
                                placeholder="è¾“å…¥ç®€çŸ­æ ‡é¢˜...">
                        </div>

                        <!-- Event Content -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1.5 ml-1">è¯¦ç»†å†…å®¹</label>
                            <textarea id="eventContent" rows="3"
                                class="w-full border-slate-200 rounded-2xl focus:border-slate-500 focus:ring-4 focus:ring-slate-100 p-4 border outline-none transition-all placeholder:text-slate-300 text-sm"
                                placeholder="è®°å½•è¿™ä¸€åˆ»çš„å„ç§ç»†èŠ‚..."></textarea>
                        </div>

                        <!-- Category/Color Selection -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-4 ml-1">åˆ†ç±»æ ‡ç­¾</label>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="colorPicker">
                                <!-- Colors generated by JS -->
                            </div>
                        </div>

                        <div class="flex gap-4 pt-4">
                            <button id="mainSubmitBtn" onclick="handleEventSubmit()"
                                class="flex-grow px-8 py-4 text-sm font-bold text-white bg-orange-200 rounded-2xl hover:bg-slate-800 shadow-xl shadow-slate-100 transition-all transform active:scale-95">
                                ä¿å­˜è®°å½•
                            </button>
                            <button id="cancelEditBtn" onclick="resetFormState()"
                                class="hidden px-8 py-4 text-sm font-bold text-slate-500 bg-slate-200 rounded-2xl hover:bg-slate-300 transition-all">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-8 py-5 bg-slate-50/80 flex justify-end gap-4 flex-shrink-0 border-t border-slate-100">
                <button onclick="closeModal()"
                    class="px-10 py-4 text-sm font-bold text-slate-700 bg-white border border-slate-200 rounded-2xl hover:bg-slate-100 transition-all active:scale-95 shadow-sm">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Application Logic -->
    <script>
        /**
         * Core Application State & Constants
         */
        const CATEGORIES = [
            { id: 'default', name: 'æ— ', color: '#FFFFFF', border: '#E5E7EB' },
            { id: 'personal', name: 'ä¸ªäºº/æˆé•¿', color: '#FEE2E2', border: '#FCA5A5' }, // Red-100
            { id: 'career', name: 'å·¥ä½œ/å­¦ä¸š', color: '#DBEAFE', border: '#93C5FD' },   // Blue-100
            { id: 'family', name: 'å®¶åº­/äº²å‹', color: '#FEF3C7', border: '#FCD34D' },   // Amber-100
            { id: 'travel', name: 'æ—…è¡Œ/æ¢ç´¢', color: '#D1FAE5', border: '#6EE7B7' },   // Emerald-100
            { id: 'health', name: 'å¥åº·/è¿åŠ¨', color: '#F3E8FF', border: '#D8B4FE' },   // Purple-100
            { id: 'milestone', name: 'é‡Œç¨‹ç¢‘', color: '#FFEDD5', border: '#FDBA74' }    // Orange-100
        ];

        // Standard Season Order (used for calculation)
        // 0: Winter, 1: Spring, 2: Summer, 3: Autumn
        const SEASON_NAMES = ['å†¬', 'æ˜¥', 'å¤', 'ç§‹'];

        const ZODIACS = ['ğŸ­ é¼ ', 'ğŸ® ç‰›', 'ğŸ¯ è™', 'ğŸ° å…”', 'ğŸ² é¾™', 'ğŸ è›‡', 'ğŸ´ é©¬', 'ğŸ‘ ç¾Š', 'ğŸµ çŒ´', 'ğŸ” é¸¡', 'ğŸ¶ ç‹—', 'ğŸ· çŒª'];

        // Initial Default World Events (1960-2025)
        const DEFAULT_WORLD_CONTEXT = {
            1960: "éæ´²ç‹¬ç«‹å¹´, æ¿€å…‰å™¨é—®ä¸–",
            1961: "åŠ åŠ æ—è¿›å…¥å¤ªç©º, æŸæ—å¢™å»ºç«‹",
            1962: "å¤å·´å¯¼å¼¹å±æœº, æŠ«å¤´å£«é¦–å¼ å•æ›²",
            1963: "è‚¯å°¼è¿ªé‡åˆº, ç¬¬ä¸€é¢—åŒæ­¥é€šä¿¡å«æ˜Ÿ",
            1964: "ç¬¬ä¸€é¢—åŸå­å¼¹çˆ†ç‚¸(ä¸­), æŠ«å¤´å£«å¸­å·ç¾æ´²",
            1965: "åˆ—æ˜‚è¯ºå¤«é¦–æ¬¡å¤ªç©ºè¡Œèµ°, ç¬¬ä¸€ä¾‹äººå·¥åˆæˆèƒ°å²›ç´ (ä¸­)",
            1966: "æ–‡é©å¼€å§‹, æ–‡åŒ–äº¤æµæš‚åœ",
            1967: "ç¬¬ä¸€é¢—æ°¢å¼¹çˆ†ç‚¸(ä¸­), ä¸–ç•Œä¸Šé¦–ä¾‹å¿ƒè„ç§»æ¤æ‰‹æœ¯",
            1968: "é˜¿æ³¢ç½—8å·ç»•æœˆ, ç¾å›½é©¬ä¸Â·è·¯å¾·Â·é‡‘é‡åˆº",
            1969: "é˜¿æ³¢ç½—11å·ç™»æœˆ, ARPANET(äº’è”ç½‘å‰èº«)è¯ç”Ÿ",
            1970: "ä¸œæ–¹çº¢ä¸€å·å‘å°„(ä¸­), é¦–ä¸ªä¸–ç•Œåœ°çƒæ—¥",
            1971: "ä¸­å›½æ¢å¤è”åˆå›½å¸­ä½, å¾®å¤„ç†å™¨Intel 4004å‘å¸ƒ",
            1972: "å°¼å…‹æ¾è®¿å, æ…•å°¼é»‘æƒ¨æ¡ˆ",
            1973: "ç¬¬ä¸€æ¬¡çŸ³æ²¹å±æœº, ç¾å›½ä»è¶Šå—æ’¤å†›",
            1974: "ç§¦å…µé©¬ä¿‘è¢«å‘ç°, ç¬¬ä¸€å°ä¸ªäººç”µè„‘Altair 8800",
            1975: "æ¯”å°”Â·ç›–èŒ¨åˆ›ç«‹å¾®è½¯, è¶Šå—æˆ˜äº‰ç»“æŸ",
            1976: "å”å±±å¤§åœ°éœ‡, ä¹”å¸ƒæ–¯åˆ›ç«‹è‹¹æœ",
            1977: "ã€Šæ˜Ÿçƒå¤§æˆ˜ã€‹é¦–æ˜ , ç¬¬ä¸€å°é‡äº§ä¸ªäººç”µè„‘Apple II",
            1978: "æ”¹é©å¼€æ”¾å¼€å§‹, ç´¢å°¼Walkmané—®ä¸–",
            1979: "ä¸­ç¾æ­£å¼å»ºäº¤, ä¼Šæœ—äººè´¨å±æœº",
            1980: "æ·±åœ³ç‰¹åŒºå»ºç«‹, è«æ–¯ç§‘å¥¥è¿ä¼š",
            1981: "IBM PCå‘å¸ƒ, ä¸–ç•Œä¸Šé¦–ä¾‹è‰¾æ»‹ç—…è¯Šæ–­",
            1982: "é©¬å²›æˆ˜äº‰, ç¬¬ä¸€å¼ CDç¢Ÿç‰‡é—®ä¸–",
            1983: "äº’è”ç½‘åè®®TCP/IPå¯ç”¨, ç¬¬ä¸€ä¸ªç§»åŠ¨ç”µè¯æ‘©æ‰˜ç½—æ‹‰8000X",
            1984: "ä¹”å¸ƒæ–¯å‘å¸ƒMacintosh, ä¸­è‹±ç­¾ç½²å…³äºé¦™æ¸¯é—®é¢˜çš„è”åˆå£°æ˜",
            1985: "ç¬¬ä¸€ç‰ˆWindowsç³»ç»Ÿå‘å¸ƒ, å¹¿åœºåè®®ç­¾ç½²",
            1986: "åˆ‡å°”è¯ºè´åˆ©æ ¸ç”µç«™äº‹æ•…, å“ˆé›·å½—æ˜Ÿå›å½’",
            1987: "é¦–æ¬¾ç§»åŠ¨ç”µè¯è¿›å…¥ä¸­å›½, 1019é»‘è‰²æ˜ŸæœŸä¸€é‡‘èå±æœº",
            1988: "ä¸­å›½é¦–æšå—æè€ƒå¯Ÿç«™è½æˆ, äº’è”ç½‘è •è™«ç—…æ¯’é¦–æ¬¡çˆ†å‘",
            1989: "æŸæ—å¢™å€’å¡Œ, ä¸‡ç»´ç½‘(WWW)æ¦‚å¿µæå‡º",
            1990: "æµ·æ¹¾æˆ˜äº‰å¼€å§‹, æµ¦ä¸œå¼€å‘å¼€æ”¾",
            1991: "è‹è”è§£ä½“, Linuxå†…æ ¸é¦–ä¸ªç‰ˆæœ¬å‘å¸ƒ",
            1992: "é‚“å°å¹³å—æ–¹è°ˆè¯, å·´å¡ç½—é‚£å¥¥è¿ä¼š",
            1993: "ã€Šä¾ç½—çºªå…¬å›­ã€‹ä¸Šæ˜ , æ¬§ç›Ÿæ­£å¼æˆç«‹",
            1994: "ä¸­å›½æ¥å…¥å›½é™…äº’è”ç½‘, å—éç»“æŸç§æ—éš”ç¦»è¿åŠ¨",
            1995: "äº¬ä¹é“è·¯å…¨çº¿é“ºé€š, äºšé©¬é€Š/eBayç›¸ç»§æˆç«‹",
            1996: "å…‹éš†ç¾Šå¤šè‰è¯ç”Ÿ, äºšç‰¹å…°å¤§å¥¥è¿ä¼š",
            1997: "é¦™æ¸¯å›å½’, æ·±è“å‡»è´¥å›½é™…è±¡æ£‹å† å†›å¡æ–¯å¸•ç½—å¤«",
            1998: "æ›¼è°·äºšè¿ä¼š, è°·æ­Œå…¬å¸æ­£å¼æˆç«‹",
            1999: "æ¾³é—¨å›å½’, æ¬§å…ƒæ­£å¼å¯åŠ¨",
            2000: "åƒç¦§å¹´, ä¸­å›½åŒ—æ–—å«æ˜Ÿå¯¼èˆªè¯•éªŒç³»ç»Ÿåœ¨è½¨",
            2001: "åŠ å…¥WTO, åŒ—äº¬ç”³å¥¥æˆåŠŸ, 911äº‹ä»¶",
            2002: "ä¸­å›½é¦–æ¬¡å‚åŠ ä¸–ç•Œæ¯, æ¬§å…ƒæ­£å¼æµé€š",
            2003: "ç¥èˆŸäº”å·è½½äººé£è¡ŒæˆåŠŸ, ä¼Šæ‹‰å…‹æˆ˜äº‰å¼€å§‹",
            2004: "ç¤¾äº¤ç½‘ç»œFacebookåˆ›ç«‹, é›…å…¸å¥¥è¿ä¼š",
            2005: "é’è—é“è·¯é“ºé€š, YouTubeæˆç«‹",
            2006: "ä¸‰å³¡å¤§åå…¨çº¿å»ºæˆ, å†¥ç‹æ˜Ÿè¢«å‰”é™¤è¡Œæ˜Ÿè¡Œåˆ—",
            2007: "åˆä»£iPhoneå‘å¸ƒ, å«¦å¨¥ä¸€å·å‘å°„",
            2008: "åŒ—äº¬å¥¥è¿ä¼šä¸¾åŠ, å…¨çƒé‡‘èæµ·å•¸",
            2009: "æ–°ä¸­å›½æˆç«‹60å‘¨å¹´, é˜¿å‡¡è¾¾å¼€å¯3Dç”µå½±æ—¶ä»£",
            2010: "ä¸Šæµ·ä¸–åšä¼š, ä¸­å›½æˆä¸ºä¸–ç•Œç¬¬äºŒå¤§ç»æµä½“",
            2011: "åˆ©æ¯”äºšæˆ˜äº‰, ä¹”å¸ƒæ–¯é€ä¸–",
            2012: "ä¼¦æ•¦å¥¥è¿ä¼š, è«è¨€è·å¾—è¯ºè´å°”æ–‡å­¦å¥–",
            2013: "â€œä¸€å¸¦ä¸€è·¯â€å€¡è®®æå‡º, å«¦å¨¥ä¸‰å·å®ç°æœˆé¢è½¯ç€é™†",
            2014: "ç§»åŠ¨æ”¯ä»˜å…ƒå¹´, é˜¿é‡Œå·´å·´åœ¨çº½äº¤æ‰€ä¸Šå¸‚",
            2015: "å± å‘¦å‘¦è·è¯ºè´å°”å’Œå¹³å¥–, å¼•åŠ›æ³¢é¦–æ¬¡è¢«ç›´æ¥æ¢æµ‹åˆ°",
            2016: "ä¸­å›½é«˜é“é‡Œç¨‹çªç ´2ä¸‡å…¬é‡Œ, è‹±å›½è„±æ¬§å…¬æŠ•",
            2017: "å›½äº§å®¢æœºC919é¦–é£æˆåŠŸ, Alphagoå‡»è´¥æŸ¯æ´",
            2018: "æ¸¯ç æ¾³å¤§æ¡¥é€šè½¦, ä¿„ç½—æ–¯ä¸–ç•Œæ¯",
            2019: "å«¦å¨¥å››å·ç™»é™†æœˆçƒèƒŒé¢, 5Gæ­£å¼å•†ç”¨, åº†ç¥æ–°ä¸­å›½æˆç«‹70å‘¨å¹´",
            2020: "ç«æ˜Ÿæ¢æµ‹å™¨å¤©é—®ä¸€å·å‘å°„, å…¨çƒååŒæŠ—å‡»ç–«æƒ…",
            2021: "ä¸­å›½ç©ºé—´ç«™æ ¸å¿ƒèˆ±å‘å°„æˆåŠŸ, ä¸œäº¬å¥¥è¿ä¼š",
            2022: "åŒ—äº¬å†¬å¥¥ä¼šä¸¾åŠ, å¡å¡”å°”ä¸–ç•Œæ¯, ä¸­å›½äººå£é¦–æ¬¡è´Ÿå¢é•¿",
            2023: "ChatGPTå¼•å‘AIé£æš´, æ­å·äºšè¿ä¼š",
            2024: "å«¦å¨¥å…­å·æœˆèƒŒé‡‡æ ·è¿”å›, å·´é»å¥¥è¿ä¼š, AIé¢†åŸŸæŠ€æœ¯çˆ†å‘",
            2025: "é¦–ä¸ªäººå·¥æ™ºèƒ½å¤§æ¨¡å‹æ·±å…¥å„è¡Œå„ä¸š, ç™»æœˆè®¡åˆ’è¿›ä¸€æ­¥æ¨è¿›"
        };

        let appState = {
            birthDate: localStorage.getItem('lifeMap_dob') || '1994-10-08',
            lifeExpectancy: parseInt(localStorage.getItem('lifeMap_expectancy')) || 100,
            yearsPerRow: parseInt(localStorage.getItem('lifeMap_yearsPerRow')) || 2, // New Setting
            showZodiac: localStorage.getItem('lifeMap_showZodiac') !== 'false',
            events: JSON.parse(localStorage.getItem('lifeMap_events')) || {}, // Key: "YYYY-SeasonIdx", Value: [{title, content, category}, ...]
            worldContext: JSON.parse(localStorage.getItem('lifeMap_context')) || DEFAULT_WORLD_CONTEXT,
            editingCell: null, // { year: 1995, seasonIdx: 0 }
            editingEventIndex: null // null for new, index for existing
        };

        // --- Data Migration (Old Single Record -> Array) ---
        (function migrateData() {
            let changed = false;
            for (let key in appState.events) {
                if (!Array.isArray(appState.events[key])) {
                    appState.events[key] = [appState.events[key]];
                    changed = true;
                }
            }
            if (changed) localStorage.setItem('lifeMap_events', JSON.stringify(appState.events));
        })();

        // Charts Instances
        let lifeProgressChartInstance = null;
        let eventDistributionChartInstance = null;

        /**
         * Initialization
         */
        document.addEventListener('DOMContentLoaded', () => {
            initUI();
            renderApp();

            // Event Listeners for inputs
            document.getElementById('birthDateInput').addEventListener('change', (e) => {
                appState.birthDate = e.target.value;
                saveSettings();
                renderApp();
            });

            document.getElementById('lifeExpectancyInput').addEventListener('input', (e) => {
                appState.lifeExpectancy = parseInt(e.target.value);
                document.getElementById('lifeExpectancyValue').innerText = appState.lifeExpectancy;
                saveSettings();
                renderApp();
            });

            document.getElementById('yearsPerRowInput').addEventListener('input', (e) => {
                appState.yearsPerRow = parseInt(e.target.value);
                document.getElementById('yearsPerRowValue').innerText = appState.yearsPerRow;
                saveSettings();
                renderApp();
            });

            document.getElementById('showZodiacToggle').addEventListener('change', (e) => {
                appState.showZodiac = e.target.checked;
                saveSettings();
                renderApp();
            });

            document.getElementById('resetDataBtn').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                    localStorage.removeItem('lifeMap_events');
                    localStorage.removeItem('lifeMap_context'); // Optional: reset context?
                    appState.events = {};
                    appState.worldContext = { ...DEFAULT_WORLD_CONTEXT };
                    renderApp();
                }
            });
        });

        function initUI() {
            document.getElementById('birthDateInput').value = appState.birthDate;
            document.getElementById('lifeExpectancyInput').value = appState.lifeExpectancy;
            document.getElementById('lifeExpectancyValue').innerText = appState.lifeExpectancy;
            document.getElementById('yearsPerRowInput').value = appState.yearsPerRow;
            document.getElementById('yearsPerRowValue').innerText = appState.yearsPerRow;
            document.getElementById('showZodiacToggle').checked = appState.showZodiac;

            const picker = document.getElementById('colorPicker');
            picker.innerHTML = CATEGORIES.map(cat => `
                <button onclick="selectCategory('${cat.id}')" 
                    class="flex items-center gap-2 p-1.5 rounded-md border text-xs hover:bg-gray-50 transition-all focus:outline-none focus:ring-1 focus:ring-indigo-500"
                    style="border-color: ${cat.border};"
                    title="${cat.name}"
                    data-cat-id="${cat.id}">
                    <span class="w-4 h-4 rounded-full flex-shrink-0" style="background-color: ${cat.color}; border: 1px solid ${cat.border};"></span>
                    <span class="truncate">${cat.name}</span>
                </button>
            `).join('');
        }

        function saveSettings() {
            localStorage.setItem('lifeMap_dob', appState.birthDate);
            localStorage.setItem('lifeMap_expectancy', appState.lifeExpectancy);
            localStorage.setItem('lifeMap_yearsPerRow', appState.yearsPerRow);
            localStorage.setItem('lifeMap_showZodiac', appState.showZodiac);
        }

        /**
         * Helpers
         */
        function getConstellation(month, day) {
            const dates = [20, 19, 21, 20, 21, 22, 23, 23, 23, 24, 22, 22];
            const constellations = ["æ‘©ç¾¯", "æ°´ç“¶", "åŒé±¼", "ç™½ç¾Š", "é‡‘ç‰›", "åŒå­", "å·¨èŸ¹", "ç‹®å­", "å¤„å¥³", "å¤©ç§¤", "å¤©è", "å°„æ‰‹", "æ‘©ç¾¯"];
            return day < dates[month - 1] ? constellations[month - 1] : constellations[month];
        }

        // Determine Start Season based on Birth Month
        // Winter: 12, 1, 2 -> Index 0
        // Spring: 3, 4, 5 -> Index 1
        // Summer: 6, 7, 8 -> Index 2
        // Autumn: 9, 10, 11 -> Index 3
        function getBirthSeasonIndex(month) {
            if (month >= 3 && month <= 5) return 1;
            if (month >= 6 && month <= 8) return 2;
            if (month >= 9 && month <= 11) return 3;
            return 0;
        }

        /**
         * Core Logic: Render the Entire App
         */
        function renderApp() {
            const gridContainer = document.getElementById('lifeGrid');
            gridContainer.innerHTML = ''; // Clear

            // Apply dynamic grid columns
            gridContainer.style.gridTemplateColumns = `repeat(${appState.yearsPerRow}, minmax(0, 1fr))`;

            const dob = new Date(appState.birthDate);
            const startYear = dob.getFullYear();
            const startMonth = dob.getMonth() + 1; // 1-12
            const startDay = dob.getDate();
            const currentYear = new Date().getFullYear();

            // Calculate Stats
            let totalYears = appState.lifeExpectancy;
            let yearsLived = currentYear - startYear;
            if (yearsLived < 0) yearsLived = 0;
            if (yearsLived > totalYears) yearsLived = totalYears;

            document.getElementById('currentAgeDisplay').innerText = `å½“å‰å¹´é¾„: ${yearsLived} å²`;

            // Identify the Rotation based on Birth Season
            const startSeasonIdx = getBirthSeasonIndex(startMonth);

            // Set Constellation in Header
            const constellation = getConstellation(startMonth, startDay);
            document.getElementById('constellationDisplay').innerText = appState.showZodiac ? `âœ¨ ${constellation}åº§` : '';

            // --- Render Grid ---
            for (let i = 0; i <= totalYears; i++) {
                const year = startYear + i;
                const age = i;
                const zodiacIndex = (year - 4) % 12;
                const zodiac = ZODIACS[zodiacIndex < 0 ? zodiacIndex + 12 : zodiacIndex];

                const isPast = year < currentYear;
                const isCurrent = year === currentYear;

                // Card Container
                const card = document.createElement('div');
                card.className = `rounded-lg border p-3 flex flex-col justify-between h-auto transition-shadow hover:shadow-md ${isCurrent ? 'bg-green-50 border-green-200 ring-2 ring-green-100' : 'bg-white border-orange-200'}`;
                if (isPast) card.classList.add('bg-opacity-80');

                // Context Text (Editable)
                const contextVal = appState.worldContext[year];
                const contextHtml = contextVal
                    ? `<div class="text-[10px] text-gray-500 mt-1 truncate border-b border-gray-100 pb-1 mb-1" title="${contextVal}">ğŸŒ ${contextVal}</div>`
                    : `<div class="h-1 mb-1"></div>`; // spacer

                // Header Info
                const zodiacDisplay = appState.showZodiac
                    ? `<div class="flex flex-col items-end justify-center">
                         <span class="text-xs text-gray-500" title="ç”Ÿè‚–">${zodiac}</span>
                       </div>`
                    : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <div>
                            <span class="text-lg font-bold text-gray-800">${year}</span>
                            <span class="ml-1 text-xs px-1.5 py-0.5 rounded text-gray-600 bg-orange-50">
                                ${age}å²
                            </span>
                        </div>
                        ${zodiacDisplay}
                    </div>
                    ${contextHtml}
                    <div class="season-grid">
                        <!-- Seasons injected here -->
                    </div>
                `;

                // Render 4 Seasons (Rotated)
                const seasonGrid = card.querySelector('.season-grid');

                for (let s = 0; s < 4; s++) {
                    const actualSeasonIdx = (startSeasonIdx + s) % 4;
                    const seasonName = SEASON_NAMES[actualSeasonIdx];

                    const eventKey = `${year}-${actualSeasonIdx}`;
                    const eventsArr = appState.events[eventKey] || [];

                    const cell = document.createElement('div');
                    cell.className = 'season-cell rounded border text-gray-500';

                    // Inner Content
                    let cellContent = `<span class="text-[9px] font-bold opacity-60 mb-1">${seasonName}å­£</span>`;

                    if (eventsArr.length > 0) {

                        const firstCat = CATEGORIES.find(c => c.id === eventsArr[0].category) || CATEGORIES[0];
                        cell.style.backgroundColor = firstCat.color;
                        cell.style.borderColor = firstCat.border;
                        cell.classList.add('text-gray-800');

                        eventsArr.forEach(evt => {
                            if (evt.title) {
                                cellContent += `<div class="event-title-tag">${evt.title}</div>`;
                            }
                        });
                    } else {
                        const currMonth = new Date().getMonth() + 1;
                        const currSeasonIdx = getBirthSeasonIndex(currMonth);
                        let isCellPast = false;
                        if (year < currentYear) isCellPast = true;
                        else if (year === currentYear) {
                            if (actualSeasonIdx < currSeasonIdx) isCellPast = true;
                        }

                        cell.style.backgroundColor = isCellPast ? '#FFF7ED' : '#FFFFFF';
                        cell.style.borderColor = '#E5E7EB';
                    }

                    cell.innerHTML = cellContent;
                    cell.onclick = () => openModal(year, actualSeasonIdx);
                    seasonGrid.appendChild(cell);
                }

                gridContainer.appendChild(card);
            }

            // --- Update Charts ---
            updateCharts(yearsLived, totalYears);
        }

        /**
         * Modal & Data Handling
         */
        let currentModalSelection = { categoryId: 'default' };

        function openModal(year, seasonIdx) {
            appState.editingCell = { year, seasonIdx };
            const key = `${year}-${seasonIdx}`;

            // Set Titles/Inputs
            document.getElementById('modalTitle').innerText = `${year}å¹´ - ${SEASON_NAMES[seasonIdx]}å­£`;
            document.getElementById('modalWorldContextInput').value = appState.worldContext[year] || '';

            refreshModalEventList();
            resetFormState();

            // Show
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.firstElementChild.classList.remove('scale-95');
                modal.firstElementChild.classList.add('scale-100');
            }, 10);
        }

        function refreshModalEventList() {
            const { year, seasonIdx } = appState.editingCell;
            const key = `${year}-${seasonIdx}`;
            const events = appState.events[key] || [];
            const area = document.getElementById('eventListArea');

            if (events.length === 0) {
                area.innerHTML = `<p class="text-xs text-gray-400 italic">æš‚æ— è®°å½•</p>`;
                return;
            }

            area.innerHTML = `<h4 class="text-sm font-bold text-gray-800">å·²è®°å½•å†…å®¹ (${events.length})</h4>` +
                events.map((evt, idx) => {
                    const cat = CATEGORIES.find(c => c.id === evt.category) || CATEGORIES[0];
                    return `
                        <div class="p-2 border rounded bg-gray-50 flex justify-between items-start gap-2">
                            <div class="flex-grow overflow-hidden">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="w-3 h-3 rounded-full" style="background-color: ${cat.color}; border: 1px solid ${cat.border};"></span>
                                    <span class="font-bold text-sm truncate">${evt.title || '(æ— æ ‡é¢˜)'}</span>
                                </div>
                                <p class="text-xs text-gray-600 line-clamp-2">${evt.content || '(æ— è¯¦æƒ…)'}</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="enterEditMode(${idx})" class="text-indigo-500 hover:text-indigo-700 text-xs font-medium">ç¼–è¾‘</button>
                                <button onclick="deleteEvent(${idx})" class="text-red-400 hover:text-red-600 text-xs">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function enterEditMode(idx) {
            const { year, seasonIdx } = appState.editingCell;
            const event = appState.events[`${year}-${seasonIdx}`][idx];

            appState.editingEventIndex = idx;

            // Populate Form
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventContent').value = event.content;
            selectCategory(event.category);

            // Update UI
            document.getElementById('formHeader').innerText = 'ä¿®æ”¹å½“å‰è®°å½•';
            document.getElementById('mainSubmitBtn').innerText = 'ç¡®è®¤ä¿®æ”¹';
            document.getElementById('cancelEditBtn').classList.remove('hidden');

            // Scroll to form
            document.getElementById('addNewEventArea').scrollIntoView({ behavior: 'smooth' });
        }

        function resetFormState() {
            appState.editingEventIndex = null;
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventContent').value = '';
            selectCategory('default');

            document.getElementById('formHeader').innerText = 'æ·»åŠ æ–°è®°å½•';
            document.getElementById('mainSubmitBtn').innerText = 'æ·»åŠ åˆ°è¯¥å­£åº¦';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        function handleEventSubmit() {
            const { year, seasonIdx } = appState.editingCell;
            const title = document.getElementById('eventTitle').value.trim();
            const content = document.getElementById('eventContent').value.trim();
            const category = currentModalSelection.categoryId;
            const newContext = document.getElementById('modalWorldContextInput').value.trim();

            if (!title && !content) {
                alert('è¯·è¾“å…¥æ ‡é¢˜æˆ–å†…å®¹');
                return;
            }

            const key = `${year}-${seasonIdx}`;

            if (appState.editingEventIndex === null) {
                // Add New
                if (!appState.events[key]) appState.events[key] = [];
                appState.events[key].push({ title, content, category });
            } else {
                // Update Existing
                appState.events[key][appState.editingEventIndex] = { title, content, category };
            }

            // Save context
            if (newContext) appState.worldContext[year] = newContext;

            saveAndSync();
            refreshModalEventList();
            resetFormState();
        }

        function deleteEvent(idx) {
            const { year, seasonIdx } = appState.editingCell;
            const key = `${year}-${seasonIdx}`;
            if (appState.events[key]) {
                appState.events[key].splice(idx, 1);
                if (appState.events[key].length === 0) delete appState.events[key];

                // If we were editing this specific one, reset form
                if (appState.editingEventIndex === idx) resetFormState();
                else if (appState.editingEventIndex > idx) appState.editingEventIndex--;

                saveAndSync();
                refreshModalEventList();
            }
        }

        function saveAndSync() {
            localStorage.setItem('lifeMap_events', JSON.stringify(appState.events));
            localStorage.setItem('lifeMap_context', JSON.stringify(appState.worldContext));
            renderApp();
        }

        function closeModal() {
            const modal = document.getElementById('editModal');
            modal.firstElementChild.classList.remove('scale-100');
            modal.firstElementChild.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
            appState.editingCell = null;
        }

        function selectCategory(id) {
            currentModalSelection.categoryId = id;
            const btns = document.getElementById('colorPicker').children;
            for (let btn of btns) {
                if (btn.dataset.catId === id) {
                    btn.classList.add('ring-2', 'ring-slate-500', 'bg-slate-50', 'border-slate-200');
                } else {
                    btn.classList.remove('ring-2', 'ring-slate-500', 'bg-slate-50', 'border-slate-200');
                }
            }
        }

        // --- Data Portability: Import / Export ---

        function exportData() {
            const dataToExport = {
                birthDate: appState.birthDate,
                lifeExpectancy: appState.lifeExpectancy,
                yearsPerRow: appState.yearsPerRow,
                showZodiac: appState.showZodiac,
                events: appState.events,
                worldContext: appState.worldContext,
                version: "1.0"
            };

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timefolding_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);

                    // Simple Validation
                    if (!imported.events || !imported.birthDate) {
                        throw new Error("æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘å…³é”®æ•°æ®");
                    }

                    // Update State
                    appState.birthDate = imported.birthDate;
                    appState.lifeExpectancy = imported.lifeExpectancy || 80;
                    appState.yearsPerRow = imported.yearsPerRow || 1;
                    appState.showZodiac = imported.showZodiac !== false;
                    appState.events = imported.events;
                    appState.worldContext = imported.worldContext || { ...DEFAULT_WORLD_CONTEXT };

                    // Save and Reload
                    saveSettings();
                    saveAndSync();
                    initUI();

                    alert("å¯¼å…¥æˆåŠŸï¼");
                } catch (err) {
                    alert("å¯¼å…¥å¤±è´¥: " + err.message);
                }
                // Clear input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Removed old single-save function in favor of saveAndSync and addNewEventToList

        /**
         * Chart Logic
         */
        function updateCharts(yearsLived, totalYears) {
            // 1. Life Progress (Doughnut)
            const progressCtx = document.getElementById('lifeProgressChart').getContext('2d');
            const remaining = totalYears - yearsLived;

            if (lifeProgressChartInstance) lifeProgressChartInstance.destroy();
            lifeProgressChartInstance = new Chart(progressCtx, {
                type: 'doughnut',
                data: {
                    labels: ['å·²åº¦è¿‡', 'é¢„æœŸ'],
                    datasets: [{
                        data: [yearsLived, remaining],
                        backgroundColor: ['#FED7AA', '#f7fee7'], // orange-200, lime-50
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, font: { family: 'Outfit', weight: 'bold' } } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    let val = context.parsed;
                                    let pct = Math.round((val / totalYears) * 100);
                                    return `${label}${val}å¹´ (${pct}%)`;
                                }
                            }
                        }
                    },
                    cutout: '80%'
                }
            });

            // 2. Event Distribution (Bar)
            const distCtx = document.getElementById('eventDistributionChart').getContext('2d');
            const counts = {};
            CATEGORIES.forEach(c => { if (c.id !== 'default') counts[c.name] = 0; });

            Object.values(appState.events).forEach(evtArr => {
                evtArr.forEach(evt => {
                    const cat = CATEGORIES.find(c => c.id === evt.category);
                    if (cat && cat.id !== 'default') {
                        counts[cat.name] = (counts[cat.name] || 0) + 1;
                    }
                });
            });

            if (eventDistributionChartInstance) eventDistributionChartInstance.destroy();
            eventDistributionChartInstance = new Chart(distCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        label: 'è®°å½•æ•°é‡',
                        data: Object.values(counts),
                        backgroundColor: Object.keys(counts).map(name => {
                            const cat = CATEGORIES.find(c => c.name === name);
                            return cat ? cat.color : '#cbd5e1';
                        }),
                        borderRadius: 12,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false }, ticks: { stepSize: 1, font: { family: 'Outfit' } } },
                        x: { grid: { display: false }, ticks: { font: { family: 'Outfit', weight: 'bold' } } }
                    }
                }
            });
        }

    </script>
</body>

</html>
